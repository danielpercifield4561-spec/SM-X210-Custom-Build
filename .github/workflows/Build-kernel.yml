name: Build Tab A9+ Custom Kernel (KSU)
on:
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-22.04

    steps:
      - name: üì• Checkout Source Code
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Install Toolchain & Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev clang llvm lld gcc-aarch64-linux-gnu tar zip

      - name: üìÅ Setup & Permissions
        run: |
          find scripts/ -type f -exec chmod +x {} + || true
          chmod +x scripts/gcc-wrapper.py || true
          
          if ! grep -q "kernelsu" drivers/Makefile; then
            echo 'obj-y += kernelsu/' >> drivers/Makefile
          fi
          
          # ---> THE GITHUB WORKSPACE FIX <---
          # This forces Kbuild to use the absolute, undeniable path to the files.
          echo "ccflags-y += -I${GITHUB_WORKSPACE}/drivers/kernelsu" >> drivers/kernelsu/Kbuild
          echo "ccflags-y += -I${GITHUB_WORKSPACE}/security/selinux" >> drivers/kernelsu/Kbuild
          echo "ccflags-y += -I${GITHUB_WORKSPACE}/security/selinux/include" >> drivers/kernelsu/Kbuild
          
          echo "ccflags-y += -I${GITHUB_WORKSPACE}/drivers/kernelsu" >> drivers/kernelsu/Makefile
          echo "ccflags-y += -I${GITHUB_WORKSPACE}/security/selinux" >> drivers/kernelsu/Makefile
          echo "ccflags-y += -I${GITHUB_WORKSPACE}/security/selinux/include" >> drivers/kernelsu/Makefile
          
          echo "ccflags-y += -I${GITHUB_WORKSPACE}/drivers" >> drivers/input/Makefile || true
          echo "ccflags-y += -I${GITHUB_WORKSPACE}/drivers" >> drivers/input/Kbuild || true
          
          mkdir -p include/kernelsu
          ln -sf ${GITHUB_WORKSPACE}/drivers/kernelsu ${GITHUB_WORKSPACE}/include/kernelsu || true
          
          # Brute force copy KSU headers
          cp drivers/kernelsu/*.h drivers/kernelsu/kernel/ || true

      - name: ü©π Apply Deep Source Code Fixes
        run: |
          sed -i 's|register unsigned long current_stack_pointer asm ("sp");|/* Removed global sp */ #define current_stack_pointer ({ unsigned long sp; asm("mov %0, sp" : "=r"(sp)); sp; })|g' arch/arm64/include/asm/stack_pointer.h || true
          sed -i 's|"brk %0" : : "I"|"brk %0" : : "n"|g' arch/arm64/include/asm/kgdb.h || true
          ln -sf $(pwd)/arch/arm64/include/asm $(pwd)/include/asm || true
          sed -i 's|#define TRACE_INCLUDE_PATH .|#define TRACE_INCLUDE_PATH ../../kernel/sched/walt|g' kernel/sched/walt/trace.h || true
          
          # Focaltech Dummy Firmware Fix
          mkdir -p drivers/input/touchscreen/focaltech_touch_spi/include/firmware
          touch drivers/input/touchscreen/focaltech_touch_spi/include/firmware/fw_sample.i || true

      - name: ‚öôÔ∏è Generate Kernel Configuration
        run: |
          export ARCH=arm64
          make ARCH=arm64 HOSTCC=gcc CC=gcc vendor/gta9pwifi_eur_open_defconfig
          
          # Apply Security & Root configs
          ./scripts/config --file .config --disable SECURITY_DEFEX
          ./scripts/config --file .config --disable SEC_RESTRICT_FORK
          ./scripts/config --file .config --enable KSU
          ./scripts/config --file .config --enable KSU_NEXT
          ./scripts/config --file .config --enable KSU_NEXT_MANUAL_HOOK
          
          make ARCH=arm64 HOSTCC=gcc CC=gcc olddefconfig

      - name: üî® Generate SELinux Headers (The Bypass Protocol)
        run: |
          # 1. Generate the core scripts needed for the kernel
          make ARCH=arm64 CC="clang --target=aarch64-linux-gnu" CROSS_COMPILE=aarch64-linux-gnu- HOSTCC=gcc CC_FOR_BUILD=gcc -j$(nproc --all) prepare
          
          echo "Bypassing Kbuild to manually generate flask.h and av_permissions.h..."
          mkdir -p security/selinux/include
          
          # 2. Locate Samsung's generator tools and raw header maps
          GEN_C=$(find scripts/selinux -name "genheaders.c" -o -name "mdp.c" | head -n 1)
          CLASSMAP=$(find security/selinux -name "classmap.h" | head -n 1)
          INITIAL_SID=$(find security/selinux -name "initial_sid_to_string.h" | head -n 1)
          
          # 3. Compile and Run the Generator Manually
          if [ -n "$GEN_C" ] && [ -n "$CLASSMAP" ] && [ -n "$INITIAL_SID" ]; then
              echo "Compiling $GEN_C..."
              gcc -Isecurity/selinux/include -Iinclude "$GEN_C" -o selinux_gen
              echo "Running generator..."
              ./selinux_gen "$CLASSMAP" "$INITIAL_SID" security/selinux/include/flask.h security/selinux/include/av_permissions.h
              echo "Generation complete!"
          else
              echo "Generators not found. Fetching standard mainline headers as ultimate failsafe..."
              wget -q https://raw.githubusercontent.com/torvalds/linux/v5.4/security/selinux/include/flask.h -O security/selinux/include/flask.h
              wget -q https://raw.githubusercontent.com/torvalds/linux/v5.4/security/selinux/include/av_permissions.h -O security/selinux/include/av_permissions.h
          fi
          
          # 4. Copy the generated files directly into KSU so it physically cannot miss them
          cp security/selinux/include/flask.h drivers/kernelsu/ || true
          cp security/selinux/include/av_permissions.h drivers/kernelsu/ || true


      - name: üî® Compile Kernel (The Main Build)
        run: |
          make ARCH=arm64 \
          CC="clang --target=aarch64-linux-gnu" \
          REAL_CC="clang --target=aarch64-linux-gnu" \
          CROSS_COMPILE=aarch64-linux-gnu- \
          LD=ld.lld \
          HOSTCC=gcc \
          CC_FOR_BUILD=gcc \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          -j$(nproc --all) \
          KCFLAGS="-I${GITHUB_WORKSPACE}/drivers/kernelsu -I${GITHUB_WORKSPACE}/security/selinux -I${GITHUB_WORKSPACE}/security/selinux/include -I${GITHUB_WORKSPACE}/drivers -Wno-error=frame-larger-than= -Wno-implicit-function-declaration -Wno-strict-prototypes -Wno-int-conversion -Wno-enum-conversion"

      - name: üì¶ Package Output for Flashing
        run: |
          mkdir -p Final_Kernel
          cp arch/arm64/boot/Image Final_Kernel/ || true
          cd Final_Kernel
          tar -cvf TabA9Plus-KSU-Kernel.tar Image || true
          
      - name: üì§ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TabA9Plus-KSU-Kernel
          path: Final_Kernel/TabA9Plus-KSU-Kernel.tar
