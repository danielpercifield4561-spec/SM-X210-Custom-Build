name: Build Tab A9+ Custom Kernel (KSU)
on:
  workflow_dispatch: # Allows manual triggering

jobs:
  build-kernel:
    runs-on: ubuntu-22.04 # We specify 22.04 for stable Clang/GCC compatibility

    steps:
      - name: ðŸ“¥ Checkout Source Code
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Install Toolchain & Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev \
          clang llvm lld gcc-aarch64-linux-gnu tar zip

      - name: ðŸ“ KernelSU Setup & Permissions
        run: |
          # 1. Aggressively fix script permissions to avoid "Permission Denied"
          find scripts/ -type f -exec chmod +x {} +
          chmod +x scripts/gcc-wrapper.py || true
          
          # 2. Integrate KernelSU folder into drivers
          if [ -d "Kernel-SU-Next-Legacy" ]; then mv Kernel-SU-Next-Legacy drivers/kernelsu; fi
          cp drivers/kernelsu/Kbuild drivers/kernelsu/Makefile || true
          
          # 3. Add KSU to the kernel's main compile list
          if ! grep -q "kernelsu" drivers/Makefile; then
            echo 'obj-y += kernelsu/' >> drivers/Makefile
          fi
          
          # 4. Create required KSU dummy file to prevent "File Not Found"
          touch drivers/kernelsu/kernel/allowlist.h
          
          # 5. Link KSU headers globally so input.c can find them
          mkdir -p include/kernelsu
          ln -sf $(pwd)/drivers/kernelsu $(pwd)/include/kernelsu

      - name: ðŸ©¹ Apply Deep Source Code Fixes
        run: |
          # 1. ARM64 Stack Pointer & KGDB Fixes
